<project basedir="." name="enoFr">
    <property name="out-extension" value="xhtml"/>
    <property name="out-folder" value="xforms"/>
    <available file="${questionnaires-folder}/${survey-name}/xforms-specific-treatment.xsl" property="specific-treatment.present"/>

    <!-- **************************** frPostProcessing ************************************************************************** -->
    <target name="frPostProcessing">
        <if>
            <equals arg1="${ENOParameters.Parameters.StudyUnit}" arg2="default"/>
            <then>
                <xslt in="${postprocessing-input-file}"
                    out="${target-folder}/${survey-name}/${form-name}/form/form-fin.${out-extension}"
                    style="${xslt.home}/post-processing/xforms/browsing.xsl" force="true" classpath="${saxon.jar}">
                    <param name="labels-folder" expression="${lang-folder}/fr"/>
                </xslt>
            </then>
            <else>
                <!-- On rajoute les questions spécifiques Coltrane -->
                <xslt in="${postprocessing-input-file}"
                    out="${target-folder}/${survey-name}/${form-name}/form/form-questions-coltrane.${out-extension}"
                    style="${xslt.home}/post-processing/xforms/insert-generic-questions.xsl" force="true" classpath="${saxon.jar}">
                    <param name="properties-file" expression="${config-folder}/${Properties.InFormat}2fr.xml"/>
                    <param name="parameters-file" expression="${questionnaires-folder}/${survey-name}/parameters.xml"/>
                </xslt>
                
                <!-- Adding the layer in charge of the survey's navigation by applying browsing.xsl stylesheet -->
                <xslt in="${target-folder}/${survey-name}/${form-name}/form/form-questions-coltrane.${out-extension}"
                    out="${target-folder}/${survey-name}/${form-name}/form/form-navigation.${out-extension}"
                    style="${xslt.home}/post-processing/xforms/browsing.xsl" force="true" classpath="${saxon.jar}">
                    <param name="labels-folder" expression="${lang-folder}/fr"/>
                </xslt>
                
                <!-- On passe au modèle Coltrane -->
                <xslt in="${target-folder}/${survey-name}/${form-name}/form/form-navigation.${out-extension}"
                    out="${target-folder}/${survey-name}/${form-name}/form/form-insee-model.${out-extension}"
                    style="${xslt.home}/post-processing/xforms/insee-model.xsl" force="true" classpath="${saxon.jar}">
                    <param name="mapping-file" expression="${temp-folder}/${survey-name}/mapping.xml"/>
                </xslt>
                
                <!-- On rajoute la couche liée à la navigation du questionnaire propre à Coltrane -->
                <xslt in="${target-folder}/${survey-name}/${form-name}/form/form-insee-model.${out-extension}"
                    out="${target-folder}/${survey-name}/${form-name}/form/form-patron.${out-extension}"
                    style="${xslt.home}/post-processing/xforms/insee-pattern.xsl" force="true" classpath="${saxon.jar}">
                    <param name="properties-file" expression="${config-folder}/${Properties.InFormat}2fr.xml"/>
                    <param name="parameters-file" expression="${questionnaires-folder}/${survey-name}/parameters.xml"/>
                    <param name="metadata-file" expression="${questionnaires-folder}/${survey-name}/metadata.xml"/>
                </xslt>
                
                <if>
                    <equals arg1="${ENOParameters.Parameters.StudyUnit}" arg2="business"/>
                    <then>
                        <!-- On rajoute la partie sur l'identification -->
                        <xslt in="${target-folder}/${survey-name}/${form-name}/form/form-patron.${out-extension}"
                            out="${target-folder}/${survey-name}/${form-name}/form/form-identification.${out-extension}"
                            style="${xslt.home}/post-processing/xforms/identification.xsl" force="true" classpath="${saxon.jar}"/>                        
                    </then>
                    <else>
                        <copy file="${target-folder}/${survey-name}/${form-name}/form/form-patron.${out-extension}"
                            tofile="${target-folder}/${survey-name}/${form-name}/form/form-identification.${out-extension}"/>
                    </else>
                </if>
                
                <!-- On surcharge la première page par une page d'accueil -->
                <xslt in="${target-folder}/${survey-name}/${form-name}/form/form-identification.${out-extension}"
                    out="${target-folder}/${survey-name}/${form-name}/form/form-accueil.${out-extension}"
                    style="${xslt.home}/post-processing/xforms/insert-welcome.xsl" force="true" classpath="${saxon.jar}">
                    <param name="properties-file" expression="${config-folder}/${Properties.InFormat}2fr.xml"/>
                    <param name="parameters-file" expression="${questionnaires-folder}/${survey-name}/parameters.xml"/>
                    <param name="metadata-file" expression="${questionnaires-folder}/${survey-name}/metadata.xml"/>
                </xslt>
                
                <!-- On surcharge la dernière page par plusieurs pages de fin -->
                <xslt in="${target-folder}/${survey-name}/${form-name}/form/form-accueil.${out-extension}"
                    out="${target-folder}/${survey-name}/${form-name}/form/form-fin.${out-extension}"
                    style="${xslt.home}/post-processing/xforms/insert-end.xsl" force="true" classpath="${saxon.jar}">
                    <param name="properties-file" expression="${config-folder}/${Properties.InFormat}2fr.xml"/>
                    <param name="parameters-file" expression="${questionnaires-folder}/${survey-name}/parameters.xml"/>
                    <param name="metadata-file" expression="${questionnaires-folder}/${survey-name}/metadata.xml"/>
                </xslt>
            </else>
        </if>
        
        <!-- On applique une verrue liée à chaque campagne -->
        <if>
            <available file="${questionnaires-folder}/${survey-name}/xforms-specific-treatment.xsl"/>
            <then>
                <xslt in="${target-folder}/${survey-name}/${form-name}/form/form-fin.${out-extension}"
                    out="${target-folder}/${survey-name}/${form-name}/form/form-verrue.${out-extension}"
                    style="${questionnaires-folder}/${survey-name}/xforms-specific-treatment.xsl" force="true" classpath="${saxon.jar}">
                    <param name="properties-file" expression="${config-folder}/${Properties.InFormat}2fr.xml"/>
                </xslt>
            </then>
            <else>
                <copy file="${target-folder}/${survey-name}/${form-name}/form/form-fin.${out-extension}"
                    tofile="${target-folder}/${survey-name}/${form-name}/form/form-verrue.${out-extension}"/>
            </else>
        </if>
        
        <!-- On fait passer une xslt pour gommer l'effet du nouvel eno sur le form produit -->
        <xslt in="${target-folder}/${survey-name}/${form-name}/form/form-verrue.${out-extension}"
            out="${target-folder}/${survey-name}/${form-name}/form/form.${out-extension}"
            style="${xslt.home}/post-processing/xforms/fix-adherence.xsl" force="true" classpath="${saxon.jar}"/>
        
        
        <!-- Si l'on souhaite supprimer les différentes étapes -->
        <delete file="${target-folder}/${survey-name}/${form-name}/form/form-basique.${out-extension}"/>
        <delete file="${target-folder}/${survey-name}/${form-name}/form/form-questions-coltrane.${out-extension}"/>
        <delete file="${target-folder}/${survey-name}/${form-name}/form/form-navigation.${out-extension}"/>
        <delete file="${target-folder}/${survey-name}/${form-name}/form/form-insee-model.${out-extension}"/>
        <delete file="${target-folder}/${survey-name}/${form-name}/form/form-patron.${out-extension}"/>
        <delete file="${target-folder}/${survey-name}/${form-name}/form/form-identification.${out-extension}"/>
        <delete file="${target-folder}/${survey-name}/${form-name}/form/form-accueil.${out-extension}"/>
        <delete file="${target-folder}/${survey-name}/${form-name}/form/form-fin.${out-extension}"/>
        <delete file="${target-folder}/${survey-name}/${form-name}/form/form-verrue.${out-extension}"/>
        
    </target>

</project>
